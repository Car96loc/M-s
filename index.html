<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Music Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Product+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        /* Variables CSS para mantener consistencia */
        :root {
            --primary-color: #1a73e8;
            --primary-hover: #1765cc;
            --secondary-color: #5f6368;
            --background-primary: #202124;
            --background-secondary: #292a2d;
            --background-tertiary: #3c4043;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #5f6368;
            --shadow-elevation-1: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-elevation-2: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
            --shadow-elevation-3: 0 1px 3px 0 rgba(60,64,67,0.29), 0 4px 8px 3px rgba(60,64,67,0.24);
            --transition-standard: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Estilos Globales */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-touch-callout: none; /* Evita menú contextual en iOS */
            -webkit-user-select: none; /* Evita selección de texto */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        body {
            font-family: 'Product Sans', Roboto, Arial, sans-serif;
            background-color: var(--background-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        /* Contenedor Principal */
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        /* Círculos flotantes de canciones */
        .floating-circles {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
        }
        .floating-circles::-webkit-scrollbar {
            display: none; /* Chrome, Safari y Opera */
        }
        .floating-circles.visible {
            opacity: 1;
            pointer-events: all;
        }
        .circular-song-item {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 15px 0;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-standard);
            position: relative;
            flex-shrink: 0;
            box-shadow: var(--shadow-elevation-2);
            -webkit-touch-callout: none; /* Evita menú contextual en iOS */
        }
        .circular-song-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none; /* Evita menú contextual en imágenes */
        }
        
        .circular-song-item.active {
            transform: scale(1.15);
        }
        /* Lista de favoritos */
        .favorites-panel {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
        }
        .favorites-panel::-webkit-scrollbar {
            display: none; /* Chrome, Safari y Opera */
        }
        .favorites-panel.visible {
            opacity: 1;
            pointer-events: all;
        }
        .favorite-item {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 15px 0;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-standard);
            position: relative;
            flex-shrink: 0;
            box-shadow: var(--shadow-elevation-2);
            -webkit-touch-callout: none; /* Evita menú contextual en iOS */
        }
        .favorite-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none; /* Evita menú contextual en imágenes */
        }
        
        .favorite-item .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 40px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .favorite-item:hover .play-icon {
            opacity: 1;
        }
        /* Panel Central: Reproductor */
        .player-panel {
            flex: 1;
            background-color: var(--background-primary);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: margin-left 0.3s ease, margin-right 0.3s ease;
            z-index: 10;
        }
        .player-panel.left-visible {
            margin-left: 100px;
        }
        .player-panel.right-visible {
            margin-right: 100px;
        }
        /* Encabezado con icono de biblioteca */
        .player-header {
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
            z-index: 15;
        }
        .library-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--background-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-standard);
            box-shadow: var(--shadow-elevation-1);
        }
        .library-icon:hover {
            background-color: var(--primary-color);
        }
        .library-icon .material-icons {
            color: var(--text-primary);
            font-size: 24px;
        }
        /* Fondo degradado dinámico */
        .player-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(26, 115, 232, 0.3), rgba(66, 133, 244, 0.1));
            opacity: 0;
            transition: opacity 1s ease;
            z-index: 5;
        }
        .player-background.active {
            opacity: 1;
        }
        /* Contenido del Reproductor */
        .player-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
            z-index: 15;
        }
        /* Barra de búsqueda */
        .search-container {
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
        }
        .search-box {
            background-color: var(--background-tertiary);
            border-radius: 24px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-elevation-1);
            transition: var(--transition-standard);
        }
        .search-box .material-icons {
            color: var(--text-secondary);
            margin-right: 12px;
            font-size: 20px;
        }
        .search-input {
            background: none;
            border: none;
            color: var(--text-primary);
            width: 100%;
            padding: 4px 0;
            font-size: 16px;
            outline: none;
        }
        .search-input::placeholder {
            color: var(--text-secondary);
        }
        .search-input:focus, .search-input:active, .search-input:hover {
            outline: none;
            -webkit-tap-highlight-color: transparent; /* Elimina resaltado en móviles */
        }
        /* Imagen del artista/canción */
        .artist-image-container {
            margin-bottom: 30px;
        }
        .artist-image {
            width: 240px;
            height: 240px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-elevation-2);
            transition: var(--transition-standard);
        }
        .artist-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none; /* Evita menú contextual en imágenes */
        }
        /* Información de la canción */
        .player-song-info {
            text-align: center;
            margin-bottom: 24px;
            max-width: 600px;
            width: 100%;
        }
        .player-song-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-song-artist {
            font-size: 18px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Barra de Progreso */
        .progress-container {
            width: 100%;
            max-width: 600px;
            margin-bottom: 24px;
        }
        .progress-bar {
            height: 6px;
            background-color: var(--background-tertiary);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            margin-bottom: 8px;
        }
        .progress-filled {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            border-radius: 3px;
            position: relative;
        }
        .progress-handle {
            position: absolute;
            top: 50%;
            right: -8px;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            transform: translateY(-50%);
            box-shadow: var(--shadow-elevation-1);
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: grab;
        }
        .progress-handle:active {
            cursor: grabbing;
        }
        .progress-bar:hover .progress-handle {
            opacity: 1;
        }
        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }
        /* Controles del Reproductor */
        .player-controls {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .control-button {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-standard);
        }
        .control-button .material-icons {
            font-size: 28px;
        }
        .control-button.play-pause .material-icons {
            font-size: 48px;
        }
        .control-button:hover {
            color: var(--primary-color);
        }
        .control-button:active {
            transform: scale(0.95);
        }
        .control-button.active {
            color: var(--primary-color);
        }
        /* Botón de compartir minimalista */
        .share-button {
            position: absolute;
            bottom: 24px;
            right: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-standard);
            z-index: 25;
        }
        .share-button:hover {
            color: var(--primary-color);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .share-button .material-icons {
            font-size: 20px;
        }
        /* Menú de compartir estilo Google actual */
        .share-menu {
            position: absolute;
            bottom: 70px;
            right: 24px;
            background-color: var(--background-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-elevation-3);
            padding: 8px 0;
            min-width: 240px;
            z-index: 30;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }
        .share-menu.show {
            display: flex;
        }
        .share-option {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: var(--transition-standard);
            border-radius: 8px;
            margin: 0 8px;
        }
        .share-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .share-option .material-icons {
            margin-right: 12px;
            color: var(--text-secondary);
            font-size: 20px;
        }
        .share-option span {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }
        /* Diálogo para agregar a favoritos */
        .favorites-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--background-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-elevation-3);
            padding: 24px;
            min-width: 320px;
            z-index: 40;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }
        .favorites-dialog.show {
            display: flex;
        }
        .dialog-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        .playlists-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        .playlist-option {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-standard);
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .playlist-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .playlist-option.selected {
            background-color: rgba(26, 115, 232, 0.2);
            border: 1px solid var(--primary-color);
        }
        .playlist-option .material-icons {
            margin-right: 12px;
            color: var(--text-secondary);
            font-size: 20px;
        }
        .playlist-option span {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }
        .create-playlist {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-standard);
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        .create-playlist:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .create-playlist .material-icons {
            margin-right: 12px;
            color: var(--text-secondary);
            font-size: 20px;
        }
        .create-playlist span {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }
        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .dialog-button {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-standard);
            border: none;
        }
        .cancel-button {
            background-color: transparent;
            color: var(--text-primary);
        }
        .cancel-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .add-button {
            background-color: var(--primary-color);
            color: white;
        }
        .add-button:hover {
            background-color: var(--primary-hover);
        }
        /* Reproductor de YouTube */
        .youtube-player {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
        }
        /* Áreas de deslizamiento */
        .slide-area-left {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            z-index: 15;
        }
        .slide-area-right {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            z-index: 15;
        }
        /* Nuevos estilos para los botones de favoritos */
        .favorites-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .favorites-controls-button {
            width: 56px;
            height: 56px;
            background-color: var(--background-tertiary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-standard);
            box-shadow: var(--shadow-elevation-2);
        }
        .favorites-controls-button:hover {
            background-color: var(--background-secondary);
            box-shadow: var(--shadow-elevation-3);
        }
        .favorites-controls-button .material-icons {
            font-size: 28px;
            color: var(--text-primary);
        }
        /* Estilos para las canciones en el panel de favoritos */
        .favorites-songs-container {
            flex: 1;
            overflow-y: auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
        }
        .favorites-songs-container::-webkit-scrollbar {
            display: none;
        }
        .favorite-song-item {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 10px 0;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-standard);
            position: relative;
            flex-shrink: 0;
            box-shadow: var(--shadow-elevation-2);
            -webkit-touch-callout: none; /* Evita menú contextual en iOS */
        }
        .favorite-song-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none; /* Evita menú contextual en imágenes */
        }
        .favorite-song-item.active {
            transform: scale(1.15);
        }
        .favorite-song-item.deleting {
            animation: pulse 0.5s infinite alternate;
            border: 2px solid rgba(234, 67, 53, 0.8);
        }
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
        /* Indicador de carga */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 25;
        }
        .loading-indicator.show {
            display: flex;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Mensaje de error */
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(234, 67, 53, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
            z-index: 25;
        }
        .error-message.show {
            display: block;
        }
        /* Mensaje de éxito */
        .success-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(52, 168, 83, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
            z-index: 25;
        }
        .success-message.show {
            display: block;
        }
        /* Indicador de carga adicional */
        .loading-more {
            display: flex;
            justify-content: center;
            padding: 10px;
            width: 100%;
        }
        .loading-more .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .floating-circles, .favorites-panel {
                width: 70px;
            }
            
            .circular-song-item, .favorite-item, .favorite-song-item {
                width: 50px;
                height: 50px;
                margin: 10px 0;
            }
            
            .artist-image {
                width: 180px;
                height: 180px;
            }
            
            .player-song-title {
                font-size: 20px;
            }
            
            .player-song-artist {
                font-size: 16px;
            }
            
            .player-content {
                padding: 20px;
            }
            
            .player-panel.left-visible {
                margin-left: 70px;
            }
            
            .player-panel.right-visible {
                margin-right: 70px;
            }
            
            .share-button {
                width: 36px;
                height: 36px;
                bottom: 20px;
                right: 20px;
            }
            
            .share-button .material-icons {
                font-size: 18px;
            }
            
            .share-menu {
                bottom: 65px;
                right: 20px;
                min-width: 200px;
            }
            
            .favorites-dialog {
                min-width: 280px;
                padding: 20px;
            }
            
            .favorites-controls-button {
                width: 48px;
                height: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="floating-circles" id="floatingCircles">
        </div>
        <div class="favorites-panel" id="favoritesPanel">
        </div>
        <div class="player-panel" id="playerPanel">
            <div class="player-background" id="playerBackground"></div>
            
            <div class="player-header">
                <div class="library-icon" id="libraryIcon">
                    <span class="material-icons-outlined">queue_music</span>
                </div>
            </div>
            
            <div class="player-content">
                <div class="search-container">
                    <div class="search-box">
                        <span class="material-icons">search</span>
                        <input type="text" class="search-input" id="searchInput" placeholder="Buscar artista en YouTube...">
                    </div>
                </div>
                
                <div class="artist-image-container" id="artistImageContainer" style="display: none;">
                    <div class="artist-image">
                        <img id="artistImage" src="" alt="Artista">
                    </div>
                </div>
                
                <div class="player-song-info">
                    <div class="player-song-title" id="songTitle">Selecciona una canción</div>
                    <div class="player-song-artist" id="songArtist">Busca un artista para comenzar</div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-filled" id="progressFilled">
                            <div class="progress-handle" id="progressHandle"></div>
                        </div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                </div>
                
                <div class="player-controls">
                    <button class="control-button" id="shuffleButton">
                        <span class="material-icons">shuffle</span>
                    </button>
                    <button class="control-button" id="prevButton">
                        <span class="material-icons">skip_previous</span>
                    </button>
                    <button class="control-button play-pause" id="playPauseButton">
                        <span class="material-icons">play_arrow</span>
                    </button>
                    <button class="control-button" id="nextButton">
                        <span class="material-icons">skip_next</span>
                    </button>
                    <button class="control-button" id="repeatButton">
                        <span class="material-icons">repeat</span>
                    </button>
                </div>
            </div>
            
            <button class="share-button" id="shareButton">
                <span class="material-icons">share</span>
            </button>
            
            <div class="share-menu" id="shareMenu">
                <div class="share-option" data-platform="whatsapp">
                    <span class="material-icons">whatsapp</span>
                    <span>WhatsApp</span>
                </div>
                <div class="share-option" data-platform="facebook">
                    <span class="material-icons">facebook</span>
                    <span>Facebook</span>
                </div>
                <div class="share-option" data-platform="twitter">
                    <span class="material-icons">alternate_email</span>
                    <span>Twitter</span>
                </div>
                <div class="share-option" data-platform="instagram">
                    <span class="material-icons">photo_camera</span>
                    <span>Instagram</span>
                </div>
                <div class="share-option" data-platform="telegram">
                    <span class="material-icons">send</span>
                    <span>Telegram</span>
                </div>
                <div class="share-option" data-platform="copy">
                    <span class="material-icons">content_copy</span>
                    <span>Copiar enlace</span>
                </div>
                <div class="share-option" data-platform="more">
                    <span class="material-icons">more_horiz</span>
                    <span>Más opciones</span>
                </div>
            </div>
            
            <div class="slide-area-left" id="slideAreaLeft"></div>
            <div class="slide-area-right" id="slideAreaRight"></div>
            
            <div class="error-message" id="errorMessage">
                No se pudieron cargar las canciones. Inténtalo de nuevo.
            </div>
            
            <div class="success-message" id="successMessage">
                Canción agregada a favoritos correctamente.
            </div>
        </div>
        
        <div class="favorites-dialog" id="favoritesDialog">
            <div class="dialog-title">Agregar a lista</div>
            <div class="playlists-container" id="playlistsContainer">
            </div>
            <div class="create-playlist" id="createPlaylistButton">
                <span class="material-icons">add</span>
                <span>Crear nueva lista</span>
            </div>
            <div class="dialog-actions">
                <button class="dialog-button cancel-button" id="cancelButton">Cancelar</button>
                <button class="dialog-button add-button" id="addButton">Agregar</button>
            </div>
        </div>
        
        <div class="favorites-dialog" id="playFavoritesDialog">
            <div class="dialog-title">Seleccionar lista para reproducir</div>
            <div class="playlists-container" id="playPlaylistsContainer">
            </div>
            <div class="dialog-actions">
                <button class="dialog-button cancel-button" id="cancelPlayButton">Cancelar</button>
                <button class="dialog-button add-button" id="playSelectedButton">Reproducir</button>
            </div>
        </div>
        
        <div id="youtube-player" class="youtube-player"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del DOM
            const playPauseButton = document.getElementById('playPauseButton');
            const playerBackground = document.getElementById('playerBackground');
            const progressBar = document.getElementById('progressBar');
            const progressFilled = document.getElementById('progressFilled');
            const progressHandle = document.getElementById('progressHandle');
            const songTitle = document.getElementById('songTitle');
            const songArtist = document.getElementById('songArtist');
            const currentTime = document.getElementById('currentTime');
            const totalTime = document.getElementById('totalTime');
            const libraryIcon = document.getElementById('libraryIcon');
            const searchInput = document.getElementById('searchInput');
            const artistImageContainer = document.getElementById('artistImageContainer');
            const artistImage = document.getElementById('artistImage');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const floatingCircles = document.getElementById('floatingCircles');
            const favoritesPanel = document.getElementById('favoritesPanel');
            const playerPanel = document.getElementById('playerPanel');
            const slideAreaLeft = document.getElementById('slideAreaLeft');
            const slideAreaRight = document.getElementById('slideAreaRight');
            const shareButton = document.getElementById('shareButton');
            const shareMenu = document.getElementById('shareMenu');
            const shuffleButton = document.getElementById('shuffleButton');
            const repeatButton = document.getElementById('repeatButton');
            const favoritesDialog = document.getElementById('favoritesDialog');
            const playlistsContainer = document.getElementById('playlistsContainer');
            const createPlaylistButton = document.getElementById('createPlaylistButton');
            const cancelButton = document.getElementById('cancelButton');
            const addButton = document.getElementById('addButton');
            
            const playFavoritesButton = document.getElementById('playFavoritesButton');
            const playFavoritesDialog = document.getElementById('playFavoritesDialog');
            const playPlaylistsContainer = document.getElementById('playPlaylistsContainer');
            const cancelPlayButton = document.getElementById('cancelPlayButton');
            const playSelectedButton = document.getElementById('playSelectedButton');
            
            // Variables para el control
            let currentSongIndex = -1;
            let isPlaying = false;
            let songs = [];
            let searchResults = []; // Guardamos los resultados de búsqueda por separado
            let player = null;
            let progressInterval = null;
            let circlesVisible = false;
            let favoritesVisible = false;
            let nextPageToken = null;
            let currentQuery = '';
            let isLoading = false;
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            let isShuffleOn = false;
            let isRepeatOn = false;
            let originalSongOrder = [];
            let selectedSongForFavorite = null;
            let selectedPlaylistId = null;
            let playlists = [];
            let favorites = {};
            let currentPlaylistId = null;
            let isDraggingProgress = false;
            
            // API Key de YouTube
            const YOUTUBE_API_KEY = 'AIzaSyDnKSv_G-UTL5taK1fsm6GKAkUXy9eTQE8';
            
            // Inicializar listas de reproducción predeterminadas
            function initializePlaylists() {
                playlists = JSON.parse(localStorage.getItem('playlists')) || [
                    { id: 'playlist1', name: 'Mis favoritos', icon: 'favorite', playlistSongs: [] },
                    { id: 'playlist2', name: 'Para entrenar', icon: 'fitness_center', playlistSongs: [] }
                ];
                
                playlists.forEach(playlist => {
                    favorites[playlist.id] = playlist.playlistSongs;
                });
                
                updatePlaylistsList(playlistsContainer);
                updatePlaylistsList(playPlaylistsContainer);
                updateFavoritesPanel();
            }
            
            // Actualizar listas de reproducción en los diálogos
            function updatePlaylistsList(container) {
                container.innerHTML = '';
                
                playlists.forEach(playlist => {
                    const playlistOption = document.createElement('div');
                    playlistOption.className = 'playlist-option';
                    playlistOption.setAttribute('data-playlist-id', playlist.id);
                    
                    const icon = document.createElement('span');
                    icon.className = 'material-icons';
                    icon.textContent = playlist.icon;
                    
                    const name = document.createElement('span');
                    name.textContent = playlist.name;
                    
                    playlistOption.appendChild(icon);
                    playlistOption.appendChild(name);
                    
                    // Si es el contenedor de reproducción, añadimos un evento para previsualizar
                    if (container.id === 'playPlaylistsContainer') {
                        playlistOption.addEventListener('click', function() {
                            container.querySelectorAll('.playlist-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            this.classList.add('selected');
                            selectedPlaylistId = playlist.id;
                            
                            // Previsualizar las canciones de esta lista en el panel derecho
                            updateFavoritesSongsList(playlist.id);
                            
                            // Mostrar el panel de favoritos si no está visible
                            if (!favoritesVisible) {
                                showFavorites();
                            }
                        });
                    } else {
                        playlistOption.addEventListener('click', function() {
                            container.querySelectorAll('.playlist-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            this.classList.add('selected');
                            selectedPlaylistId = playlist.id;
                        });
                    }
                    
                    container.appendChild(playlistOption);
                });
                
                if (playlists.length > 0) {
                    selectedPlaylistId = playlists[0].id;
                    const firstOption = container.querySelector('.playlist-option');
                    if (firstOption) {
                        firstOption.classList.add('selected');
                    }
                }
            }
            
            function savePlaylists() {
                localStorage.setItem('playlists', JSON.stringify(playlists));
            }
            
            setTimeout(() => {
                playerBackground.classList.add('active');
            }, 500);
            
            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "0:00";
                
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }
            
            function updateProgress() {
                if (player && player.getCurrentTime) {
                    const currentTimeValue = player.getCurrentTime();
                    const duration = player.getDuration();
                    
                    if (duration > 0) {
                        const progress = (currentTimeValue / duration) * 100;
                        progressFilled.style.width = `${progress}%`;
                        currentTime.textContent = formatTime(currentTimeValue);
                        totalTime.textContent = formatTime(duration);
                    }
                }
            }
            
            function loadYouTubeVideo(videoId) {
                if (player) {
                    player.loadVideoById(videoId);
                }
            }
            
            function playSong(index) {
                if (index < 0 || index >= songs.length) return;
                
                currentSongIndex = index;
                
                songTitle.textContent = songs[index].title;
                songArtist.textContent = songs[index].artist;
                
                artistImage.src = songs[index].thumbnail;
                artistImageContainer.style.display = 'block';
                
                // Actualizar el estado activo en ambos paneles
                const circularSongItems = document.querySelectorAll('.circular-song-item');
                circularSongItems.forEach((item, i) => {
                    if (i === index) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                const favoriteSongItems = document.querySelectorAll('.favorite-song-item');
                favoriteSongItems.forEach((item, i) => {
                    if (i === index) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                loadYouTubeVideo(songs[index].videoId);
                
                const icon = playPauseButton.querySelector('.material-icons');
                icon.textContent = 'pause';
                isPlaying = true;
                
                if (progressInterval) clearInterval(progressInterval);
                progressInterval = setInterval(updateProgress, 1000);
            }
            
            function showCircles() {
                if(favoritesVisible) {
                    hideFavorites();
                }
                floatingCircles.classList.add('visible');
                playerPanel.classList.add('left-visible');
                circlesVisible = true;
            }
            
            function hideCircles() {
                floatingCircles.classList.remove('visible');
                playerPanel.classList.remove('left-visible');
                circlesVisible = false;
            }
            
            function showFavorites() {
                if(circlesVisible) {
                    hideCircles();
                }
                favoritesPanel.classList.add('visible');
                playerPanel.classList.add('right-visible');
                favoritesVisible = true;
            }
            
            function hideFavorites() {
                favoritesPanel.classList.remove('visible');
                playerPanel.classList.remove('right-visible');
                favoritesVisible = false;
            }
            
            function shuffleSongs() {
                if (songs.length === 0) return;
                
                if (originalSongOrder.length === 0) {
                    originalSongOrder = [...songs];
                }
                
                for (let i = songs.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [songs[i], songs[j]] = [songs[j], songs[i]];
                }
                
                // No actualizamos los círculos para mantener los resultados de búsqueda
                if (currentPlaylistId) {
                    updateFavoritesSongsList(currentPlaylistId);
                }
                
                if (currentSongIndex !== -1) {
                    const currentSong = songs[currentSongIndex];
                    currentSongIndex = songs.findIndex(song => 
                        song.videoId === currentSong.videoId
                    );
                }
            }
            
            function restoreOriginalOrder() {
                if (originalSongOrder.length === 0) return;
                
                songs = [...originalSongOrder];
                
                // No actualizamos los círculos para mantener los resultados de búsqueda
                if (currentPlaylistId) {
                    updateFavoritesSongsList(currentPlaylistId);
                }
                
                if (currentSongIndex !== -1) {
                    const currentSong = songs[currentSongIndex];
                    currentSongIndex = songs.findIndex(song => 
                        song.videoId === currentSong.videoId
                    );
                }
            }
            
            playPauseButton.addEventListener('click', function() {
                if (!player || songs.length === 0) {
                    if (songs.length > 0) {
                        playSong(0);
                    }
                    return;
                }
                
                const icon = this.querySelector('.material-icons');
                if (isPlaying) {
                    player.pauseVideo();
                    icon.textContent = 'play_arrow';
                    isPlaying = false;
                    if (progressInterval) clearInterval(progressInterval);
                } else {
                    player.playVideo();
                    icon.textContent = 'pause';
                    isPlaying = true;
                    progressInterval = setInterval(updateProgress, 1000);
                }
            });
            
            // Mejorar la funcionalidad de la barra de progreso
            progressBar.addEventListener('mousedown', function(e) {
                isDraggingProgress = true;
                updateProgressFromMouse(e);
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDraggingProgress) {
                    updateProgressFromMouse(e);
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDraggingProgress = false;
            });
            
            // Eventos táctiles para la barra de progreso
            progressBar.addEventListener('touchstart', function(e) {
                isDraggingProgress = true;
                updateProgressFromTouch(e);
                e.preventDefault(); // Prevenir el comportamiento por defecto
            }, { passive: false });
            
            document.addEventListener('touchmove', function(e) {
                if (isDraggingProgress) {
                    updateProgressFromTouch(e);
                    e.preventDefault(); // Prevenir el comportamiento por defecto
                }
            }, { passive: false });
            
            document.addEventListener('touchend', function() {
                isDraggingProgress = false;
            });
            
            function updateProgressFromMouse(e) {
                if (!player || !player.getDuration || isNaN(player.getDuration())) return;
                
                const rect = progressBar.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                const percentage = Math.max(0, Math.min(1, x / width));
                
                const duration = player.getDuration();
                if (duration && !isNaN(duration)) {
                    player.seekTo(duration * percentage, true);
                    progressFilled.style.width = `${percentage * 100}%`;
                    currentTime.textContent = formatTime(duration * percentage);
                }
            }
            
            function updateProgressFromTouch(e) {
                if (!player || !player.getDuration || isNaN(player.getDuration())) return;
                
                const rect = progressBar.getBoundingClientRect();
                const x = e.changedTouches[0].clientX - rect.left;
                const width = rect.width;
                const percentage = Math.max(0, Math.min(1, x / width));
                
                const duration = player.getDuration();
                if (duration && !isNaN(duration)) {
                    player.seekTo(duration * percentage, true);
                    progressFilled.style.width = `${percentage * 100}%`;
                    currentTime.textContent = formatTime(duration * percentage);
                }
            }
            
            document.getElementById('nextButton').addEventListener('click', function() {
                if (songs.length === 0) return;
                
                let nextIndex;
                if (isShuffleOn) {
                    nextIndex = Math.floor(Math.random() * songs.length);
                } else {
                    nextIndex = currentSongIndex < songs.length - 1 ? currentSongIndex + 1 : 0;
                }
                
                playSong(nextIndex);
            });
            
            document.getElementById('prevButton').addEventListener('click', function() {
                if (songs.length === 0) return;
                
                let prevIndex;
                if (isShuffleOn) {
                    prevIndex = Math.floor(Math.random() * songs.length);
                } else {
                    prevIndex = currentSongIndex > 0 ? currentSongIndex - 1 : songs.length - 1;
                }
                
                playSong(prevIndex);
            });
            
            shuffleButton.addEventListener('click', function() {
                isShuffleOn = !isShuffleOn;
                
                if (isShuffleOn) {
                    this.classList.add('active');
                    shuffleSongs();
                } else {
                    this.classList.remove('active');
                    restoreOriginalOrder();
                }
            });
            
            repeatButton.addEventListener('click', function() {
                isRepeatOn = !isRepeatOn;
                
                if (isRepeatOn) {
                    this.classList.add('active');
                } else {
                    this.classList.remove('active');
                }
            });
            
            libraryIcon.addEventListener('click', function() {
                if (circlesVisible) {
                    hideCircles();
                } else {
                    showCircles();
                }
            });
            
            slideAreaLeft.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, false);
            
            slideAreaLeft.addEventListener('touchmove', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;
                
                if (Math.abs(diffX) > Math.abs(diffY) && diffX > 50) {
                    showCircles();
                } else if (Math.abs(diffX) > Math.abs(diffY) && diffX < -50) {
                    if (circlesVisible) {
                        hideCircles();
                    }
                }
            }, false);
            
            slideAreaLeft.addEventListener('click', function() {
                if (circlesVisible) {
                    hideCircles();
                } else {
                    showCircles();
                }
            });
            
            slideAreaRight.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, false);
            
            slideAreaRight.addEventListener('touchmove', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;
                
                if (Math.abs(diffX) > Math.abs(diffY) && diffX < -50) {
                    showFavorites();
                } else if (Math.abs(diffX) > Math.abs(diffY) && diffX > 50) {
                    if (favoritesVisible) {
                        hideFavorites();
                    }
                }
            }, false);
            
            slideAreaRight.addEventListener('click', function() {
                if (favoritesVisible) {
                    hideFavorites();
                } else {
                    showFavorites();
                }
            });
            
            shareButton.addEventListener('click', function() {
                const shareMenu = document.getElementById('shareMenu');
                shareMenu.classList.toggle('show');
            });
            
            document.addEventListener('click', function(e) {
                const shareButton = document.getElementById('shareButton');
                const shareMenu = document.getElementById('shareMenu');
                if (!shareButton.contains(e.target) && !shareMenu.contains(e.target)) {
                    shareMenu.classList.remove('show');
                }
            });
            
            document.querySelectorAll('.share-option').forEach(option => {
                option.addEventListener('click', function() {
                    const platform = this.getAttribute('data-platform');
                    shareContent(platform);
                    document.getElementById('shareMenu').classList.remove('show');
                });
            });
            
            function shareContent(platform) {
                if (currentSongIndex === -1 || songs.length === 0) {
                    showTemporaryMessage(errorMessage, "No hay ninguna canción para compartir.");
                    return;
                }
                
                const song = songs[currentSongIndex];
                const shareText = `Estoy escuchando "${song.title}" de ${song.artist}`;
                const shareUrl = `https://www.youtube.com/watch?v=${song.videoId}`;
                
                switch(platform) {
                    case 'whatsapp':
                        window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`, '_blank');
                        break;
                    case 'facebook':
                        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank');
                        break;
                    case 'twitter':
                        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`, '_blank');
                        break;
                    case 'instagram':
                        copyToClipboard(shareUrl);
                        showTemporaryMessage(errorMessage, "Enlace copiado al portapapeles. Pégalo en Instagram.");
                        break;
                    case 'telegram':
                        window.open(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`, '_blank');
                        break;
                    case 'copy':
                        copyToClipboard(shareUrl);
                        showTemporaryMessage(errorMessage, "Enlace copiado al portapapeles.");
                        break;
                    case 'more':
                        if (navigator.share) {
                            navigator.share({
                                title: song.title,
                                text: shareText,
                                url: shareUrl
                            }).catch(err => {
                                console.error('Error al compartir:', err);
                            });
                        } else {
                            copyToClipboard(shareUrl);
                            showTemporaryMessage(errorMessage, "Enlace copiado al portapapeles.");
                        }
                        break;
                }
            }
            
            function showTemporaryMessage(element, message) {
                element.textContent = message;
                element.classList.add('show');
                setTimeout(() => {
                    element.classList.remove('show');
                }, 3000);
            }
            
            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
            
            function addToFavorites(playlistId) {
                if (!selectedSongForFavorite) return;
                
                const isAlreadyInPlaylist = favorites[playlistId].some(song => 
                    song.videoId === selectedSongForFavorite.videoId
                );
                
                if (isAlreadyInPlaylist) {
                    showTemporaryMessage(errorMessage, "Esta canción ya está en la lista de favoritos.");
                    return;
                }
                
                favorites[playlistId].push(selectedSongForFavorite);
                
                // Actualizar la lista de reproducción en el array de playlists
                const playlist = playlists.find(p => p.id === playlistId);
                if (playlist) {
                    playlist.playlistSongs = favorites[playlistId];
                    savePlaylists();
                }
                
                showTemporaryMessage(successMessage, "Canción agregada a favoritos correctamente.");
                favoritesDialog.classList.remove('show');
            }
            
            function updateFavoritesPanel() {
                const container = favoritesPanel;
                container.innerHTML = '';
                
                const controls = document.createElement('div');
                controls.className = 'favorites-controls';
                
                const playButton = document.createElement('div');
                playButton.className = 'favorites-controls-button';
                playButton.id = 'playFavoritesButton';
                playButton.innerHTML = '<span class="material-icons">equalizer</span>';
                
                controls.appendChild(playButton);
                container.appendChild(controls);
                
                // Añadimos el event listener para el botón de reproducción
                playButton.addEventListener('click', function() {
                    updatePlaylistsList(playPlaylistsContainer);
                    playFavoritesDialog.classList.add('show');
                });
                
                // Añadimos un contenedor para las canciones de la lista de reproducción seleccionada
                const songsContainer = document.createElement('div');
                songsContainer.className = 'favorites-songs-container';
                songsContainer.id = 'favoritesSongsContainer';
                container.appendChild(songsContainer);
            }
            
            function updateFavoritesSongsList(playlistId) {
                currentPlaylistId = playlistId;
                const container = document.getElementById('favoritesSongsContainer');
                container.innerHTML = '';
                
                const playlistSongs = favorites[playlistId];
                
                if (playlistSongs.length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.style.color = 'var(--text-secondary)';
                    emptyMessage.style.fontSize = '12px';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.padding = '10px';
                    emptyMessage.textContent = 'Lista vacía';
                    container.appendChild(emptyMessage);
                    return;
                }
                
                playlistSongs.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = 'favorite-song-item';
                    songItem.setAttribute('data-song-index', index);
                    
                    const img = document.createElement('img');
                    img.src = song.thumbnail;
                    img.alt = song.title;
                    
                    songItem.appendChild(img);
                    
                    // Variables para controlar la pulsación larga para eliminar
                    let pressTimer;
                    let isLongPress = false;
                    
                    // Eventos táctiles para dispositivos móviles
                    songItem.addEventListener('touchstart', function(e) {
                        isLongPress = false;
                        
                        pressTimer = setTimeout(() => {
                            isLongPress = true;
                            // Añadir clase para animación
                            this.classList.add('deleting');
                            
                            // Mostrar confirmación para eliminar
                            if (confirm(`¿Eliminar "${song.title}" de la lista?`)) {
                                removeSongFromPlaylist(playlistId, index);
                            } else {
                                // Quitar clase de animación si se cancela
                                this.classList.remove('deleting');
                            }
                        }, 800); // Aumentamos el tiempo para evitar activaciones accidentales
                        
                        // Prevenir el menú contextual
                        e.preventDefault();
                    }, { passive: false });
                    
                    songItem.addEventListener('touchend', function(e) {
                        clearTimeout(pressTimer);
                        
                        // Quitar clase de animación si no se confirmó la eliminación
                        if (!isLongPress) {
                            this.classList.remove('deleting');
                        }
                        
                        // Prevenir el menú contextual
                        e.preventDefault();
                    });
                    
                    songItem.addEventListener('touchmove', function(e) {
                        // Si se mueve el dedo, cancelamos la pulsación larga
                        clearTimeout(pressTimer);
                        this.classList.remove('deleting');
                    }, { passive: true });
                    
                    // Eventos de mouse para escritorio
                    songItem.addEventListener('mousedown', function(e) {
                        isLongPress = false;
                        
                        pressTimer = setTimeout(() => {
                            isLongPress = true;
                            // Añadir clase para animación
                            this.classList.add('deleting');
                            
                            // Mostrar confirmación para eliminar
                            if (confirm(`¿Eliminar "${song.title}" de la lista?`)) {
                                removeSongFromPlaylist(playlistId, index);
                            } else {
                                // Quitar clase de animación si se cancela
                                this.classList.remove('deleting');
                            }
                        }, 800); // Aumentamos el tiempo para evitar activaciones accidentales
                        
                        // Prevenir el menú contextual
                        e.preventDefault();
                    });
                    
                    songItem.addEventListener('mouseup', function(e) {
                        clearTimeout(pressTimer);
                        
                        // Quitar clase de animación si no se confirmó la eliminación
                        if (!isLongPress) {
                            this.classList.remove('deleting');
                        }
                        
                        // Prevenir el menú contextual
                        e.preventDefault();
                    });
                    
                    songItem.addEventListener('mouseleave', function() {
                        clearTimeout(pressTimer);
                        this.classList.remove('deleting');
                    });
                    
                    // Prevenir el menú contextual
                    songItem.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        return false;
                    });
                    
                    // Event listener para reproducir la canción (solo si no fue una pulsación larga)
                    songItem.addEventListener('click', function(e) {
                        if (!isLongPress) {
                            // Si estamos reproduciendo una lista de favoritos, reproducimos la canción
                            if (songs.length === playlistSongs.length && 
                                songs.every((song, idx) => song.videoId === playlistSongs[idx].videoId)) {
                                playSong(index);
                            } else {
                                // Si no, cargamos la lista de favoritos y reproducimos la canción
                                songs = [...playlistSongs];
                                originalSongOrder = [...songs];
                                playSong(index);
                            }
                        }
                    });
                    
                    container.appendChild(songItem);
                });
            }
            
            function removeSongFromPlaylist(playlistId, songIndex) {
                // Eliminar la canción de la lista de favoritos
                favorites[playlistId].splice(songIndex, 1);
                
                // Actualizar la lista de reproducción en el array de playlists
                const playlist = playlists.find(p => p.id === playlistId);
                if (playlist) {
                    playlist.playlistSongs = favorites[playlistId];
                    savePlaylists();
                }
                
                // Actualizar la vista
                updateFavoritesSongsList(playlistId);
                
                // Si la canción eliminada es la que se está reproduciendo, detener la reproducción
                if (currentSongIndex === songIndex && 
                    songs.length === favorites[playlistId].length + 1 && 
                    songs.every((song, idx) => {
                        if (idx < songIndex) return song.videoId === favorites[playlistId][idx].videoId;
                        if (idx > songIndex) return song.videoId === favorites[playlistId][idx - 1].videoId;
                        return false;
                    })) {
                    player.pauseVideo();
                    const icon = playPauseButton.querySelector('.material-icons');
                    icon.textContent = 'play_arrow';
                    isPlaying = false;
                    if (progressInterval) clearInterval(progressInterval);
                    
                    currentSongIndex = -1;
                    songTitle.textContent = 'Canción eliminada';
                    songArtist.textContent = 'Selecciona otra canción';
                }
                
                showTemporaryMessage(successMessage, "Canción eliminada de la lista correctamente.");
            }
            
            function playPlaylist(playlistId) {
                const playlistSongs = favorites[playlistId];
                
                if (playlistSongs.length === 0) {
                    showTemporaryMessage(errorMessage, "Esta lista de favoritos está vacía.");
                    return;
                }
                
                // Reemplazamos la lista actual con las canciones de la lista de favoritos
                songs = [...playlistSongs];
                originalSongOrder = [...songs];
                
                // No actualizamos los círculos para mantener los resultados de búsqueda
                
                // Actualizamos el panel derecho con las canciones de la lista de reproducción
                updateFavoritesSongsList(playlistId);
                
                // Si hay canciones, reproducimos la primera
                if (songs.length > 0) {
                    playSong(0);
                }
                
                // Mostramos el panel de favoritos
                if (!favoritesVisible) {
                    showFavorites();
                }
                
                playFavoritesDialog.classList.remove('show');
            }
            
            function onYouTubeIframeAPIReady() {
                player = new YT.Player('youtube-player', {
                    height: '1',
                    width: '1',
                    playerVars: {
                        'autoplay': 0,
                        'controls': 0,
                        'disablekb': 1,
                        'enablejsapi': 1,
                        'fs': 0,
                        'iv_load_policy': 3,
                        'modestbranding': 1,
                        'rel': 0,
                        'showinfo': 0
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onError': onPlayerError
                    }
                });
            }
            
            function onPlayerReady(event) {
                console.log("Reproductor de YouTube listo");
            }
            
            function onPlayerStateChange(event) {
                if (event.data == YT.PlayerState.ENDED) {
                    if (isRepeatOn) {
                        player.seekTo(0);
                        player.playVideo();
                    } else {
                        let nextIndex;
                        if (isShuffleOn) {
                            nextIndex = Math.floor(Math.random() % songs.length);
                        } else {
                            nextIndex = currentSongIndex < songs.length - 1 ? currentSongIndex + 1 : 0;
                        }
                        playSong(nextIndex);
                    }
                } else if (event.data == YT.PlayerState.PLAYING) {
                    const icon = playPauseButton.querySelector('.material-icons');
                    icon.textContent = 'pause';
                    isPlaying = true;
                    if (progressInterval) clearInterval(progressInterval);
                    progressInterval = setInterval(updateProgress, 1000);
                } else if (event.data == YT.PlayerState.PAUSED) {
                    const icon = playPauseButton.querySelector('.material-icons');
                    icon.textContent = 'play_arrow';
                    isPlaying = false;
                    if (progressInterval) clearInterval(progressInterval);
                }
            }
            
            function onPlayerError(event) {
                console.error("Error en el reproductor de YouTube:", event.data);
                showTemporaryMessage(errorMessage, "Error al reproducir el video. Intenta con otra canción.");
                
                const icon = playPauseButton.querySelector('.material-icons');
                icon.textContent = 'play_arrow';
                isPlaying = false;
            }
            
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) {
                        // Ocultar el teclado en dispositivos móviles
                        this.blur();
                        searchArtistOnYouTube(query);
                    }
                }
            });
            
            // Eliminar el sombreado en la barra de búsqueda al pegar texto
            searchInput.addEventListener('paste', function(e) {
                // Prevenir el comportamiento por defecto para evitar el sombreado
                e.preventDefault();
                
                // Obtener el texto pegado
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                
                // Insertar el texto en la posición actual del cursor
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + pastedText + this.value.substring(end);
                
                // Mover el cursor al final del texto pegado
                this.selectionStart = start + pastedText.length;
                this.selectionEnd = start + pastedText.length;
            });
            
            function searchArtistOnYouTube(artistName) {
                currentQuery = artistName;
                nextPageToken = null;
                searchResults = []; // Guardamos los resultados de búsqueda
                songs = [];
                currentSongIndex = -1;
                originalSongOrder = [];
                
                // Aumentar el número de resultados iniciales de 10 a 20
                let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(artistName + ' music')}&type=video&videoCategoryId=10&maxResults=20&key=${YOUTUBE_API_KEY}`;
                
                fetch(searchUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta de la red: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.items && data.items.length > 0) {
                            nextPageToken = data.nextPageToken;
                            const artistImage = `https://picsum.photos/seed/${artistName.replace(/\s+/g, '')}/400/400.jpg`;
                            
                            data.items.forEach((item) => {
                                const videoId = item.id.videoId;
                                const title = item.snippet.title;
                                const channelTitle = item.snippet.channelTitle;
                                let thumbnail = item.snippet.thumbnails.high ? item.snippet.thumbnails.high.url : item.snippet.thumbnails.default.url;
                                
                                const song = {
                                    title: title,
                                    artist: channelTitle,
                                    videoId: videoId,
                                    thumbnail: thumbnail,
                                    artistImage: artistImage
                                };
                                
                                searchResults.push(song);
                                songs.push(song);
                            });
                            
                            originalSongOrder = [...songs];
                            updateCirclesList();
                            
                            if (!circlesVisible) {
                                showCircles();
                            }
                            
                            songTitle.textContent = `Resultados para: ${artistName}`;
                            songArtist.textContent = `${songs.length} canciones encontradas`;
                            
                            if (player) {
                                player.stopVideo();
                            }
                            
                            const icon = playPauseButton.querySelector('.material-icons');
                            icon.textContent = 'play_arrow';
                            isPlaying = false;
                            
                            progressFilled.style.width = '0%';
                            currentTime.textContent = '0:00';
                            totalTime.textContent = '0:00';
                        } else {
                            throw new Error('No se encontraron videos en la respuesta');
                        }
                    })
                    .catch(error => {
                        console.error('Error al buscar en YouTube:', error);
                        showTemporaryMessage(errorMessage, "No se encontraron resultados. Intenta con otra búsqueda.");
                    });
            }
            
            function loadMoreSongs() {
                if (isLoading || !nextPageToken || !currentQuery) return;
                
                isLoading = true;
                
                // Mostrar indicador de carga
                const loadingMore = document.createElement('div');
                loadingMore.className = 'loading-more';
                loadingMore.innerHTML = '<div class="spinner"></div>';
                floatingCircles.appendChild(loadingMore);
                
                let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(currentQuery + ' music')}&type=video&videoCategoryId=10&maxResults=20&pageToken=${nextPageToken}&key=${YOUTUBE_API_KEY}`;
                
                fetch(searchUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta de la red: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.items && data.items.length > 0) {
                            nextPageToken = data.nextPageToken;
                            
                            data.items.forEach((item) => {
                                const videoId = item.id.videoId;
                                const title = item.snippet.title;
                                const channelTitle = item.snippet.channelTitle;
                                let thumbnail = item.snippet.thumbnails.high ? item.snippet.thumbnails.high.url : item.snippet.thumbnails.default.url;
                                
                                const song = {
                                    title: title,
                                    artist: channelTitle,
                                    videoId: videoId,
                                    thumbnail: thumbnail,
                                    artistImage: songs[0].artistImage
                                };
                                
                                searchResults.push(song);
                                songs.push(song);
                            });
                            
                            if (!isShuffleOn) {
                                originalSongOrder = [...songs];
                            }
                            
                            updateCirclesList();
                            songArtist.textContent = `${songs.length} canciones encontradas`;
                        } else {
                            nextPageToken = null;
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar más canciones:', error);
                        showTemporaryMessage(errorMessage, "Error al cargar más canciones. Inténtalo de nuevo.");
                    })
                    .finally(() => {
                        isLoading = false;
                        // Eliminar indicador de carga
                        const loadingElement = floatingCircles.querySelector('.loading-more');
                        if (loadingElement) {
                            loadingElement.remove();
                        }
                    });
            }
            
            function updateCirclesList() {
                floatingCircles.innerHTML = '';
                
                // Siempre mostramos los resultados de búsqueda en el panel izquierdo
                const songsToShow = searchResults.length > 0 ? searchResults : songs;
                
                songsToShow.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = 'circular-song-item';
                    songItem.setAttribute('data-song-index', index);
                    
                    const img = document.createElement('img');
                    img.src = song.thumbnail;
                    img.alt = song.title;
                    
                    songItem.appendChild(img);
                    
                    // Variables para controlar el deslizamiento y el clic
                    let touchStartX = 0;
                    let touchEndX = 0;
                    let touchStartY = 0;
                    let touchEndY = 0;
                    let isDragging = false;
                    let pressTimer;
                    let isLongPress = false;
                    
                    // Eventos táctiles para dispositivos móviles
                    songItem.addEventListener('touchstart', function(e) {
                        touchStartX = e.changedTouches[0].screenX;
                        touchStartY = e.changedTouches[0].screenY;
                        isLongPress = false;
                        
                        pressTimer = setTimeout(() => {
                            isLongPress = true;
                            selectedSongForFavorite = songsToShow[index];
                            favoritesDialog.classList.add('show');
                        }, 500);
                        
                        // Prevenir el menú contextual
                        e.preventDefault();
                    }, { passive: false });
                    
                    songItem.addEventListener('touchmove', function(e) {
                        touchEndX = e.changedTouches[0].screenX;
                        touchEndY = e.changedTouches[0].screenY;
                        
                        const diffX = Math.abs(touchEndX - touchStartX);
                        const diffY = Math.abs(touchEndY - touchStartY);
                        
                        // Si el deslizamiento es mayor que el umbral, consideramos que es un deslizamiento
                        if (diffX > 10 || diffY > 10) {
                            isDragging = true;
                            clearTimeout(pressTimer);
                        }
                    }, { passive: true });
                    
                    songItem.addEventListener('touchend', function(e) {
                        touchEndX = e.changedTouches[0].screenX;
                        touchEndY = e.changedTouches[0].screenY;
                        
                        const diffX = Math.abs(touchEndX - touchStartX);
                        const diffY = Math.abs(touchEndY - touchStartY);
                        
                        clearTimeout(pressTimer);
                        
                        // Si no fue un deslizamiento y no fue una pulsación larga, reproducimos la canción
                        if (!isDragging && !isLongPress && diffX < 10 && diffY < 10) {
                            // Si los resultados de búsqueda son diferentes a la lista actual, actualizamos
                            if (songsToShow !== songs) {
                                songs = [...songsToShow];
                                originalSongOrder = [...songs];
                            }
                            playSong(index);
                        }
                        
                        isDragging = false;
                    });
                    
                    // Eventos de mouse para escritorio
                    songItem.addEventListener('mousedown', function(e) {
                        isLongPress = false;
                        
                        pressTimer = setTimeout(() => {
                            isLongPress = true;
                            selectedSongForFavorite = songsToShow[index];
                            favoritesDialog.classList.add('show');
                        }, 500);
                        
                        // Prevenir el menú contextual
                        e.preventDefault();
                    });
                    
                    songItem.addEventListener('mouseup', function() {
                        clearTimeout(pressTimer);
                        if (!isLongPress) {
                            // Si los resultados de búsqueda son diferentes a la lista actual, actualizamos
                            if (songsToShow !== songs) {
                                songs = [...songsToShow];
                                originalSongOrder = [...songs];
                            }
                            playSong(index);
                        }
                    });
                    
                    songItem.addEventListener('mouseleave', function() {
                        clearTimeout(pressTimer);
                    });
                    
                    // Prevenir el menú contextual
                    songItem.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        return false;
                    });
                    
                    floatingCircles.appendChild(songItem);
                });
                
                setupInfiniteScroll();
            }
            
            function setupInfiniteScroll() {
                floatingCircles.addEventListener('scroll', function() {
                    // Reducir el umbral para cargar más canciones antes
                    if (
                        floatingCircles.scrollTop + floatingCircles.clientHeight >= floatingCircles.scrollHeight - 200 &&
                        nextPageToken &&
                        !isLoading
                    ) {
                        loadMoreSongs();
                    }
                });
            }
            
            cancelButton.addEventListener('click', function() {
                favoritesDialog.classList.remove('show');
            });
            
            addButton.addEventListener('click', function() {
                if (selectedPlaylistId && selectedSongForFavorite) {
                    addToFavorites(selectedPlaylistId);
                } else {
                    showTemporaryMessage(errorMessage, "Selecciona una lista antes de agregar.");
                }
            });
            
            cancelPlayButton.addEventListener('click', function() {
                playFavoritesDialog.classList.remove('show');
            });
            
            playSelectedButton.addEventListener('click', function() {
                if (selectedPlaylistId) {
                    playPlaylist(selectedPlaylistId);
                }
            });
            
            // Corregir el evento para crear una nueva lista
            createPlaylistButton.addEventListener('click', function() {
                const playlistName = prompt('Nombre de la nueva lista:');
                if (playlistName && playlistName.trim()) {
                    const newPlaylist = {
                        id: 'playlist' + Date.now(),
                        name: playlistName.trim(),
                        icon: 'playlist_add',
                        playlistSongs: []
                    };
                    playlists.push(newPlaylist);
                    favorites[newPlaylist.id] = newPlaylist.playlistSongs;
                    savePlaylists();
                    updatePlaylistsList(playlistsContainer);
                    updatePlaylistsList(playPlaylistsContainer);
                    showTemporaryMessage(successMessage, `Lista "${newPlaylist.name}" creada.`);
                }
            });
            
            initializePlaylists();
            
            window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
        });
    </script>
</body>
</html>